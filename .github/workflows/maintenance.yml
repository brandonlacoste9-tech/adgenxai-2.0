name: Unified Maintenance

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/maintenance.yml'
      - 'scripts/**'

permissions:
  contents: write
  issues: write
  pull-requests: read
  discussions: write

jobs:
  maintenance:
    runs-on: ubuntu-latest
    name: Run Maintenance Tasks
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Install dependencies
        run: |
          # Install jq for JSON processing
          sudo apt-get update
          sudo apt-get install -y jq
      
      - name: Run hygiene check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -f scripts/update_hygiene.sh ]; then
            chmod +x scripts/update_hygiene.sh
            bash scripts/update_hygiene.sh || echo "Hygiene check completed with warnings"
          else
            echo "‚ö†Ô∏è Hygiene script not found, skipping..."
          fi
      
      - name: Update badges
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üìã Checking badge status..."
          # Add badge update logic here if needed
          echo "‚úÖ Badge check complete"
      
      - name: Clean up old artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üßπ Cleaning up old workflow artifacts..."
          # Keep artifacts for 90 days, delete older ones
          gh api repos/${{ github.repository }}/actions/artifacts --paginate \
            | jq -r '.artifacts[] | select(.created_at | fromdateiso8601 < (now - 7776000)) | .id' \
            | xargs -I {} gh api -X DELETE repos/${{ github.repository }}/actions/artifacts/{} || true
          echo "‚úÖ Artifact cleanup complete"
      
      - name: Summary
        run: |
          echo "## Maintenance Summary" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ All maintenance tasks completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "- Hygiene check: Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Badge updates: Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Artifact cleanup: Complete" >> $GITHUB_STEP_SUMMARY
